"""
pricing.py - Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ³Ø¹ÙŠØ± v5.0
Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø±Ø³ÙˆÙ… Stripe
Ø¶Ù…Ø§Ù† Ø±Ø¨Ø­ â‰¥ $4 Ù„ÙƒÙ„ Ø·Ù„Ø¨
"""

from typing import Dict


class PricingEngine:
    """Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ³Ø¹ÙŠØ± v5.0"""
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONSTANTS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Stripe fees
    STRIPE_PERCENT = 0.029  # 2.9%
    STRIPE_FLAT = 0.30      # $0.30
    
    # Service fee
    SERVICE_PERCENT = 0.12  # 12%
    SERVICE_MIN = 3.49      # Ø­Ø¯ Ø£Ø¯Ù†Ù‰
    SERVICE_MAX = 7.49      # Ø­Ø¯ Ø£Ù‚ØµÙ‰
    SERVICE_SMALL = 4.99    # Ù„Ù„Ø·Ù„Ø¨Ø§Øª < $20
    
    # Driver pay (Option B - Balanced & Competitive)
    DRIVER_BASE = 4.00      # Base pay (Ø²ÙŠØ§Ø¯Ø© $0.50)
    DRIVER_PER_KM = 0.80    # Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± (Ø²ÙŠØ§Ø¯Ø© $0.10)
    DRIVER_PER_MIN = 0.12   # Ù„ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø²ÙŠØ§Ø¯Ø© $0.02)
    
    # Platform fees
    DRIVER_SUBSCRIPTION_FEE = 0.25  # Ù„ÙƒÙ„ Ø·Ù„Ø¨
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DELIVERY FEES (Ø´Ø±Ø§Ø¦Ø­ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @staticmethod
    def delivery_fee(distance_km: float) -> float:
        """
        Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        
        < 2 ÙƒÙ…  â†’ $4.49
        2-3 ÙƒÙ…  â†’ $5.99
        3-4 ÙƒÙ…  â†’ $7.49
        4-5 ÙƒÙ…  â†’ $8.49
        5-7 ÙƒÙ…  â†’ $10.49
        7+ ÙƒÙ…   â†’ $12.49 + $0.50/km
        """
        if distance_km < 2:
            return 4.49
        elif distance_km < 3:
            return 5.99
        elif distance_km < 4:
            return 7.49
        elif distance_km < 5:
            return 8.49
        elif distance_km < 7:
            return 10.49
        else:
            return round(12.49 + (distance_km - 7) * 0.50, 2)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SERVICE FEE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @classmethod
    def service_fee(cls, food_price: float) -> float:
        """
        Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©
        
        < $20  â†’ $4.99 (Ø±Ø³ÙˆÙ… Ø®Ø§ØµØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©)
        â‰¥ $20  â†’ 12% (Ø­Ø¯ Ø£Ø¯Ù†Ù‰ $3.49ØŒ Ø­Ø¯ Ø£Ù‚ØµÙ‰ $7.49)
        """
        # Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©: Ø±Ø³ÙˆÙ… Ø«Ø§Ø¨ØªØ© Ø£Ø¹Ù„Ù‰
        if food_price < 20:
            return cls.SERVICE_SMALL
        
        # Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©
        base = food_price * cls.SERVICE_PERCENT
        return round(max(cls.SERVICE_MIN, min(cls.SERVICE_MAX, base)), 2)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # RESTAURANT COMMISSION (Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø·Ø¹Ù…)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @staticmethod
    def restaurant_commission(food_price: float) -> float:
        """
        Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø·Ø¹Ù… (Ø´Ø±Ø§Ø¦Ø­)
        
        < $20    â†’ 18%
        $20-40   â†’ 15%
        $40-80   â†’ 12%
        > $80    â†’ 10%
        """
        if food_price < 20:
            rate = 0.18
        elif food_price < 40:
            rate = 0.15
        elif food_price < 80:
            rate = 0.12
        else:
            rate = 0.10
        
        return round(food_price * rate, 2)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DRIVER PAY (Ø£Ø¬Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @classmethod
    def driver_pay(cls, distance_km: float, duration_min: float) -> float:
        """
        Ø£Ø¬Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        
        Base: $3.50
        + $0.70 Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        + $0.10 Ù„ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        """
        total = (
            cls.DRIVER_BASE +
            (distance_km * cls.DRIVER_PER_KM) +
            (duration_min * cls.DRIVER_PER_MIN)
        )
        return round(total, 2)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STRIPE FEE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @classmethod
    def stripe_fee(cls, total_amount: float) -> float:
        """
        Ø±Ø³ÙˆÙ… Stripe
        
        2.9% + $0.30
        """
        return round(
            total_amount * cls.STRIPE_PERCENT + cls.STRIPE_FLAT,
            2
        )
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # COMPLETE CALCULATION
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @classmethod
    def calculate(cls, food_price: float, distance_km: float, 
                  duration_min: float) -> Dict:
        """
        Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·Ù„Ø¨
        
        Args:
            food_price: Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…
            distance_km: Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
            duration_min: Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        
        Returns:
            dict Ù…Ø¹ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        """
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 1. ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        delivery_fee = cls.delivery_fee(distance_km)
        service_fee = cls.service_fee(food_price)
        customer_total = round(food_price + delivery_fee + service_fee, 2)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 2. Ø±Ø³ÙˆÙ… Stripe (Ù…Ø®ØµÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stripe_fee = cls.stripe_fee(customer_total)
        net_received = round(customer_total - stripe_fee, 2)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 3. Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        commission = cls.restaurant_commission(food_price)
        restaurant_gets = round(food_price - commission, 2)
        driver_payment = cls.driver_pay(distance_km, duration_min)
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 4. Ø±Ø¨Ø­ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØµØ§ÙÙŠ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        platform_profit = round(
            net_received - 
            restaurant_gets - 
            driver_payment - 
            cls.DRIVER_SUBSCRIPTION_FEE,
            2
        )
        
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Return complete breakdown
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        return {
            # Input
            "food_price": food_price,
            "distance_km": distance_km,
            "duration_min": duration_min,
            
            # Customer invoice
            "delivery_fee": delivery_fee,
            "service_fee": service_fee,
            "customer_total": customer_total,
            
            # Stripe
            "stripe_fee": stripe_fee,
            "net_received": net_received,
            
            # Payouts
            "commission": commission,
            "restaurant_gets": restaurant_gets,
            "driver_pay": driver_payment,
            "driver_subscription_fee": cls.DRIVER_SUBSCRIPTION_FEE,
            
            # Platform profit
            "platform_profit": platform_profit,
            
            # Status
            "profitable": platform_profit >= 4.0
        }
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # HELPER: Pretty print breakdown
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @staticmethod
    def format_breakdown(result: Dict) -> str:
        """ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ø±Ø¶"""
        return f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Pricing Breakdown - ${result['food_price']:.2f} Food, {result['distance_km']:.1f}km
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ CUSTOMER INVOICE:
  ğŸ½ï¸  Food:           ${result['food_price']:.2f}
  ğŸšš Delivery:        ${result['delivery_fee']:.2f}
  âš™ï¸  Service:         ${result['service_fee']:.2f}
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ’° TOTAL:           ${result['customer_total']:.2f}

ğŸ’³ STRIPE:
  Fee (2.9% + $0.30): -${result['stripe_fee']:.2f}
  Net received:       ${result['net_received']:.2f}

ğŸ“¤ PAYOUTS:
  Restaurant:         ${result['restaurant_gets']:.2f}
  Driver:             ${result['driver_pay']:.2f}
  Driver sub fee:     ${result['driver_subscription_fee']:.2f}

{'âœ…' if result['profitable'] else 'âŒ'} PLATFORM PROFIT:    ${result['platform_profit']:.2f}
"""


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUICK TEST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == "__main__":
    pricing = PricingEngine()
    
    # Test cases
    tests = [
        (10, 1, 10),   # Small order
        (15, 1, 10),   # Min order
        (20, 1, 10),   # Threshold
        (25, 3, 20),   # Normal order
        (50, 4, 25),   # Large order
    ]
    
    for food, km, minutes in tests:
        result = pricing.calculate(food, km, minutes)
        print(pricing.format_breakdown(result))
